import logging
from typing import Any, Dict

from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

from {{ package_name }}.config import load_settings
from {{ package_name }}.infra.middleware import (
    RequestIDMiddleware,
    RequestLoggingMiddleware,
    ErrorHandlingMiddleware,
    RateLimitMiddleware,
    SecurityHeadersMiddleware,
)
from {{ package_name }}.infra.logging import configure_logging
{% if use_telemetry -%}
from {{ package_name }}.infra.telemetry import configure_telemetry
{% endif -%}
{% if use_sqlalchemy -%}
from {{ package_name }}.infra.db import create_db
{% endif -%}
from {{ package_name }}.service.handlers import ExampleService


def build_container() -> Dict[str, Any]:
    settings = load_settings()

    configure_logging(app_name=settings.app_name, env=settings.env)
    logger = logging.getLogger(settings.app_name)

    {% if use_telemetry -%}
    telemetry = configure_telemetry(enabled=settings.otel_enabled)
    {% else -%}
    telemetry = None
    {% endif -%}

    {% if use_sqlalchemy -%}
    db = create_db(settings.database_url)
    {% else -%}
    db = None
    {% endif -%}

    example_service = ExampleService(logger=logger, telemetry=telemetry, db=db)

    return {
        "settings": settings,
        "logger": logger,
        "telemetry": telemetry,
        "db": db,
        "example_service": example_service,
    }


def create_app() -> FastAPI:
    settings = load_settings()
    app = FastAPI(
        title=settings.app_name,
        version=settings.app_version,
        description="FastAPI application generated from template",
    )
    
    container = build_container()
    app.state.container = container

    # Add middleware (order matters - last added is first executed)
    # Security headers (runs first, adds headers to all responses)
    app.add_middleware(SecurityHeadersMiddleware)
    
    # Error handling (runs last, catches all errors)
    app.add_middleware(ErrorHandlingMiddleware)
    
    # Request logging (runs second to last)
    app.add_middleware(RequestLoggingMiddleware)
    
    # Rate limiting (runs early, before processing)
    app.add_middleware(RateLimitMiddleware, requests_per_minute=settings.rate_limit_per_minute)
    
    # Request ID (runs early, adds ID for tracing)
    app.add_middleware(RequestIDMiddleware)
    
    # CORS middleware (runs first, handles CORS)
    app.add_middleware(
        CORSMiddleware,
        allow_origins=settings.cors_origins,
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )

    {% if use_telemetry -%}
    telemetry = container["telemetry"]

    @app.on_event("startup")
    def _startup() -> None:
        telemetry.start()

    @app.on_event("shutdown")
    def _shutdown() -> None:
        telemetry.shutdown()
    {% endif -%}

    # API versioning - include router with /v1 prefix
    from {{ package_name }}.api.routes import router, healthz
    from fastapi import Request
    
    # Versioned API routes
    app.include_router(router, prefix="/v1", tags=["v1"])
    
    # Health check at root level (no versioning)
    @app.get("/healthz")
    async def healthz_root(request: Request):
        """Health check endpoint (no versioning)."""
        return healthz(request)

    return app
